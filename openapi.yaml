openapi: 3.1.0
info:
  title: Table Master API
  version: 1.0.0
  description: |
    API para gestión de áreas, mesas y reservas del restaurante.
    Contrato API-FIRST para implementación en Vercel Functions.
  license:
    name: MIT
    identifier: MIT
servers:
  - url: https://YOUR-VERCEL-DOMAIN.vercel.app/api
    description: Production
  - url: http://127.0.0.1:3000/api
    description: Local (vercel dev)
tags:
  - name: Health
    description: Estado operativo del API
  - name: Areas
    description: Catalogo de areas del restaurante
  - name: Tables
    description: Gestion de mesas y posiciones
  - name: Reservations
    description: Gestion de reservas y estados
  - name: Availability
    description: Consulta de disponibilidad
  - name: Floor
    description: Snapshot de floor layout
paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      responses:
        "200":
          description: API saludable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: table-master-api
                  timestamp:
                    type: string
                    format: date-time
        "422": &a1
          $ref: "#/components/responses/ValidationError"
      operationId: getHealth
  /areas:
    get:
      tags:
        - Areas
      summary: Listar áreas
      responses:
        "200":
          description: Lista de áreas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Area"
        "422": *a1
      operationId: getAreas
  /floor-layout:
    get:
      tags:
        - Floor
      summary: Obtener snapshot del floor
      parameters:
        - in: query
          name: date
          schema:
            type: string
            pattern: ^\d{4}-\d{2}-\d{2}$
          description: Fecha YYYY-MM-DD
        - in: query
          name: areaId
          schema:
            type: string
      responses:
        "200":
          description: Snapshot con áreas, mesas y reservas
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FloorLayoutResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: getFloorLayout
  /tables:
    get:
      tags:
        - Tables
      summary: Listar mesas
      parameters:
        - in: query
          name: areaId
          schema:
            type: string
      responses:
        "200":
          description: Lista de mesas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/RestaurantTable"
        "422": *a1
      operationId: listTables
    post:
      tags:
        - Tables
      summary: Crear mesa (solo áreas no VIP)
      description: Máximo 8 mesas por área no VIP.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTableInput"
      responses:
        "201":
          description: Mesa creada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RestaurantTable"
        "409":
          $ref: "#/components/responses/ConflictError"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: createTable
  /tables/{id}/position:
    patch:
      tags:
        - Tables
      summary: Actualizar posición de mesa
      description: Soporta control de concurrencia con expectedVersion.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTablePositionInput"
      responses:
        "200":
          description: Mesa actualizada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RestaurantTable"
        "409":
          $ref: "#/components/responses/ConcurrencyError"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: updateTablePosition
  /tables/{id}/release:
    post:
      tags:
        - Tables
      summary: Liberar mesa (marca reserva activa como completed)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Resultado de liberación
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  released:
                    type: boolean
                  reservation:
                    $ref: "#/components/schemas/Reservation"
        "422": *a1
      operationId: releaseTable
  /reservations:
    get:
      tags:
        - Reservations
      summary: Listar reservas por fecha
      parameters:
        - in: query
          name: date
          schema:
            type: string
            pattern: ^\d{4}-\d{2}-\d{2}$
          required: true
        - in: query
          name: areaId
          schema:
            type: string
      responses:
        "200":
          description: Reservas filtradas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Reservation"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: listReservations
    post:
      tags:
        - Reservations
      summary: Crear reserva
      description: Requiere Idempotency-Key para evitar duplicados.
      parameters:
        - in: header
          name: Idempotency-Key
          required: true
          schema:
            type: string
            minLength: 8
            maxLength: 128
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateReservationInput"
      responses:
        "201":
          description: Reserva creada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reservation"
        "409":
          $ref: "#/components/responses/ConflictError"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: createReservation
  /reservations/{id}/status:
    patch:
      tags:
        - Reservations
      summary: Cambiar estado de reserva
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: "#/components/schemas/ReservationStatus"
      responses:
        "200":
          description: Reserva actualizada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reservation"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: updateReservationStatus
  /walkins:
    post:
      tags:
        - Reservations
      summary: Crear ocupación walk-in
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateWalkInInput"
      responses:
        "201":
          description: Walk-in creado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reservation"
        "409":
          $ref: "#/components/responses/ConflictError"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: createWalkin
  /availability:
    get:
      tags:
        - Availability
      summary: Consultar disponibilidad
      parameters:
        - in: query
          name: date
          required: true
          schema:
            type: string
            pattern: ^\d{4}-\d{2}-\d{2}$
        - in: query
          name: partySize
          required: true
          schema:
            type: integer
            minimum: 1
        - in: query
          name: startTime
          required: true
          schema:
            type: string
            pattern: ^([01]\d|2[0-3]):[0-5]\d$
        - in: query
          name: areaPreference
          schema:
            type: string
      responses:
        "200":
          description: Sugerencias de disponibilidad
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AvailabilityResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
      operationId: getAvailability
components:
  responses:
    ValidationError:
      description: Error de validación
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ConflictError:
      description: Conflicto de negocio o solape
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ConcurrencyError:
      description: Conflicto de concurrencia
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
  schemas:
    ErrorResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details: {}
      required:
        - code
        - message
    Area:
      type: object
      required:
        - id
        - name
        - maxTables
      properties:
        id:
          type: string
        name:
          type: string
          enum:
            - Terraza
            - Patio
            - Lobby
            - Bar
            - Salones VIP
        maxTables:
          type: integer
          minimum: 1
    TableType:
      type: string
      enum:
        - standard
        - square
        - circular
    ReservationStatus:
      type: string
      enum:
        - pending
        - confirmed
        - cancelled
        - completed
        - no_show
    RestaurantTable:
      type: object
      required:
        - id
        - areaId
        - capacity
        - type
        - name
        - isVIP
        - canMerge
        - mergeGroup
        - x
        - y
      properties:
        id:
          type: string
        areaId:
          type: string
        capacity:
          type: integer
        type:
          $ref: "#/components/schemas/TableType"
        name:
          type: string
        isVIP:
          type: boolean
        canMerge:
          type: boolean
        mergeGroup:
          type:
            - string
            - "null"
        x:
          type: number
        y:
          type: number
        version:
          type: integer
        updatedAt:
          type: string
          format: date-time
    Reservation:
      type: object
      required:
        - id
        - tableIds
        - clientName
        - partySize
        - date
        - startTime
        - endTime
        - status
        - duration
        - notes
      properties:
        id:
          type: string
        tableIds:
          type: array
          minItems: 1
          items:
            type: string
        clientName:
          type: string
        partySize:
          type: integer
          minimum: 1
        date:
          type: string
          pattern: ^\d{4}-\d{2}-\d{2}$
        startTime:
          type: string
          pattern: ^([01]\d|2[0-3]):[0-5]\d$
        endTime:
          type: string
          pattern: ^([01]\d|2[0-3]):[0-5]\d$
        status:
          $ref: "#/components/schemas/ReservationStatus"
        duration:
          type: integer
          minimum: 0
        notes:
          type: string
    CreateReservationInput:
      type: object
      required:
        - tableIds
        - clientName
        - partySize
        - date
        - startTime
        - endTime
        - status
        - duration
        - notes
      properties:
        tableIds:
          type: array
          minItems: 1
          items:
            type: string
        clientName:
          type: string
          minLength: 1
        partySize:
          type: integer
          minimum: 1
        date:
          type: string
          pattern: ^\d{4}-\d{2}-\d{2}$
        startTime:
          type: string
          pattern: ^([01]\d|2[0-3]):[0-5]\d$
        endTime:
          type: string
          pattern: ^([01]\d|2[0-3]):[0-5]\d$
        status:
          $ref: "#/components/schemas/ReservationStatus"
        duration:
          type: integer
          minimum: 0
        notes:
          type: string
    CreateWalkInInput:
      type: object
      required:
        - tableId
      properties:
        tableId:
          type: string
        clientName:
          type: string
        partySize:
          type: integer
          minimum: 1
        notes:
          type: string
    CreateTableInput:
      type: object
      required:
        - areaId
      properties:
        areaId:
          type: string
        capacity:
          type: integer
          enum:
            - 2
            - 4
            - 6
            - 8
        type:
          type: string
          enum:
            - standard
            - square
    UpdateTablePositionInput:
      type: object
      required:
        - x
        - y
      properties:
        x:
          type: number
          minimum: 0
          maximum: 100
        y:
          type: number
          minimum: 0
          maximum: 100
        expectedVersion:
          type: integer
          minimum: 1
        areaId:
          type: string
        canvasWidth:
          type: number
          minimum: 1
        canvasHeight:
          type: number
          minimum: 1
        isMergedView:
          type: boolean
    AvailabilitySuggestion:
      type: object
      required:
        - tableIds
        - capacity
        - tableName
      properties:
        tableIds:
          type: array
          items:
            type: string
        capacity:
          type: integer
        tableName:
          type: string
    AvailabilityResponse:
      type: object
      required:
        - suggestedTables
        - alternatives
      properties:
        suggestedTables:
          type: array
          items:
            $ref: "#/components/schemas/AvailabilitySuggestion"
        alternatives:
          type: array
          items:
            $ref: "#/components/schemas/AvailabilitySuggestion"
    FloorLayoutResponse:
      type: object
      required:
        - date
        - areaId
        - areas
        - tables
        - reservations
      properties:
        date:
          type: string
          pattern: ^\d{4}-\d{2}-\d{2}$
        areaId:
          type:
            - string
            - "null"
        areas:
          type: array
          items:
            $ref: "#/components/schemas/Area"
        tables:
          type: array
          items:
            $ref: "#/components/schemas/RestaurantTable"
        reservations:
          type: array
          items:
            $ref: "#/components/schemas/Reservation"
security: []
